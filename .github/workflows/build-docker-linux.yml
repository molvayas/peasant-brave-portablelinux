name: Build Brave Browser (Linux in Docker on Windows)

on:
  workflow_dispatch:
    inputs:
      build_linux_x64:
        description: 'Build Linux x64 (in Docker on Windows)'
        required: true
        type: boolean
        default: true
      build_linux_arm64:
        description: 'Build Linux arm64 (in Docker on Windows)'
        required: true
        type: boolean
        default: false
      build_type:
        description: 'Build type: Component or Release'
        required: true
        type: choice
        options:
          - Component
          - Release
        default: Component
      publish_release:
        description: 'Publish GitHub release'
        required: true
        type: boolean
        default: false
      require_approval:
        description: 'Require manual approval before publishing'
        required: true
        type: boolean
        default: true

jobs:
  # ============================================================================
  # Linux x64 Build Chain (6 stages) - Docker on Windows
  # ============================================================================
  
  docker-linux-x64-build-1:
    name: Docker Linux x64 - Stage 1
    if: ${{ inputs.build_linux_x64 }}
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-x64-build-2:
    name: Docker Linux x64 - Stage 2
    if: ${{ inputs.build_linux_x64 }}
    needs: docker-linux-x64-build-1
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.docker-linux-x64-build-1.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-x64-build-3:
    name: Docker Linux x64 - Stage 3
    if: ${{ inputs.build_linux_x64 }}
    needs: docker-linux-x64-build-2
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.docker-linux-x64-build-2.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-x64-build-4:
    name: Docker Linux x64 - Stage 4
    if: ${{ inputs.build_linux_x64 }}
    needs: docker-linux-x64-build-3
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.docker-linux-x64-build-3.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-x64-build-5:
    name: Docker Linux x64 - Stage 5
    if: ${{ inputs.build_linux_x64 }}
    needs: docker-linux-x64-build-4
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.docker-linux-x64-build-4.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-x64-build-6:
    name: Docker Linux x64 - Stage 6 (Final)
    if: ${{ inputs.build_linux_x64 }}
    needs: docker-linux-x64-build-5
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.docker-linux-x64-build-5.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  # ============================================================================
  # Linux arm64 Build Chain (6 stages) - Docker on Windows
  # ============================================================================
  
  docker-linux-arm64-build-1:
    name: Docker Linux arm64 - Stage 1
    if: ${{ inputs.build_linux_arm64 }}
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-arm64-build-2:
    name: Docker Linux arm64 - Stage 2
    if: ${{ inputs.build_linux_arm64 }}
    needs: docker-linux-arm64-build-1
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.docker-linux-arm64-build-1.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-arm64-build-3:
    name: Docker Linux arm64 - Stage 3
    if: ${{ inputs.build_linux_arm64 }}
    needs: docker-linux-arm64-build-2
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.docker-linux-arm64-build-2.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-arm64-build-4:
    name: Docker Linux arm64 - Stage 4
    if: ${{ inputs.build_linux_arm64 }}
    needs: docker-linux-arm64-build-3
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.docker-linux-arm64-build-3.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-arm64-build-5:
    name: Docker Linux arm64 - Stage 5
    if: ${{ inputs.build_linux_arm64 }}
    needs: docker-linux-arm64-build-4
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.docker-linux-arm64-build-4.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  docker-linux-arm64-build-6:
    name: Docker Linux arm64 - Stage 6 (Final)
    if: ${{ inputs.build_linux_arm64 }}
    needs: docker-linux-arm64-build-5
    uses: ./.github/workflows/builder-docker-linux.yml
    with:
      platform: linux
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.docker-linux-arm64-build-5.outputs.finished }}
      build_type: ${{ inputs.build_type }}
    secrets:
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}

  # ============================================================================
  # Collect All Artifacts
  # ============================================================================
  
  collect-artifacts:
    name: Collect All Build Artifacts
    needs: [docker-linux-x64-build-6, docker-linux-arm64-build-6]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux x64 artifact
        if: ${{ inputs.build_linux_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux
          path: ./artifacts/linux-x64
      
      - name: Download Linux arm64 artifact
        if: ${{ inputs.build_linux_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux-arm64
          path: ./artifacts/linux-arm64
      
      - name: List all artifacts
        run: |
          echo "=== All Build Artifacts ==="
          if [ -d ./artifacts ]; then
            find ./artifacts -type f -exec ls -lh {} \;
          else
            echo "No artifacts directory found"
          fi
          echo ""
          echo "âœ“ All selected builds completed!"
          if [ "${{ inputs.publish_release }}" == "true" ]; then
            echo "âœ“ Ready for release publishing"
          else
            echo "â„¹ï¸  Test build - artifacts available in workflow run"
            echo "â„¹ï¸  Release publishing is disabled"
          fi
      
      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./artifacts/
          retention-days: 7

  # ============================================================================
  # Publish Release (Optional)
  # ============================================================================
  
  publish-release:
    name: ðŸ“¦ Publish Release
    if: ${{ inputs.publish_release }}
    needs: collect-artifacts
    runs-on: ubuntu-latest
    environment: ${{ inputs.require_approval && 'production' || '' }}
    
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./release
      
      - name: Display release contents
        run: |
          echo "=== Release Contents ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""
          echo "Publishing to GitHub Releases..."
      
      - name: Generate build summary
        id: summary
        run: |
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Linux x64 (Docker): ${{ inputs.build_linux_x64 }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux arm64 (Docker): ${{ inputs.build_linux_arm64 }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build type: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Publishing release: ${{ inputs.publish_release }}" >> $GITHUB_STEP_SUMMARY
          echo "- Approval required: ${{ inputs.require_approval }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Built using Ubuntu container on Windows runner for maximum disk space." >> $GITHUB_STEP_SUMMARY
          
          PLATFORMS=""
          ${{ inputs.build_linux_x64 }} && PLATFORMS="${PLATFORMS}- Linux x64\n"
          ${{ inputs.build_linux_arm64 }} && PLATFORMS="${PLATFORMS}- Linux arm64\n"
          echo "platforms<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PLATFORMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-docker-${{ github.sha }}
          name: Brave Browser Build ${{ github.run_number }} (Docker on Windows)
          body: |
            ## Brave Browser - Linux Build (Docker on Windows)
            
            Built using Ubuntu container on Windows runner for maximum disk space.
            
            **Build**: #${{ github.run_number }}
            **Commit**: ${{ github.sha }}
            **Triggered by**: @${{ github.actor }}
            **Date**: ${{ github.event.repository.updated_at }}
            **Build method**: Ubuntu 22.04 container on Windows runner
            
            ### Platforms Included:
            ${{ steps.summary.outputs.platforms }}
            
            ### Installation
            Download the appropriate package for your platform and extract it.
            
            ### Build Details
            - Container: Ubuntu 22.04
            - Host: Windows runner with D drive
            - Disk space: ~90GB available (no cleanup needed!)
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ./release/**/*.tar.xz
            ./release/**/*.zip
      
      - name: Release published
        run: |
          echo "âœ“ Release published successfully!"
          echo "Check: https://github.com/${{ github.repository }}/releases"

