name: Test Disk Space Cleanup (LVM Method)

on:
  workflow_dispatch:
    inputs:
      root_reserve_mb:
        description: 'Space to leave free on root filesystem (MB)'
        required: false
        type: string
        default: '1024'
      temp_reserve_mb:
        description: 'Space to leave free on temp filesystem /mnt (MB)'
        required: false
        type: string
        default: '100'
      swap_size_mb:
        description: 'Swap space to create (MB)'
        required: false
        type: string
        default: '4096'
      overprovision_lvm:
        description: 'Use sparse files for LVM (can be risky)'
        required: false
        type: boolean
        default: false
      build_mount_path:
        description: 'Mount path for build space (empty = $GITHUB_WORKSPACE)'
        required: false
        type: string
        default: ''
      remove_dotnet:
        description: 'Remove .NET runtime and libraries'
        required: false
        type: boolean
        default: false
      remove_android:
        description: 'Remove Android SDKs and Tools'
        required: false
        type: boolean
        default: false
      remove_haskell:
        description: 'Remove GHC (Haskell) artifacts'
        required: false
        type: boolean
        default: false
      remove_codeql:
        description: 'Remove CodeQL Action Bundles'
        required: false
        type: boolean
        default: false
      remove_docker_images:
        description: 'Remove cached Docker images'
        required: false
        type: boolean
        default: false

jobs:
  test-disk-space-lvm:
    name: Test Disk Space Cleanup (LVM Method)
    runs-on: ubuntu-latest
    
    steps:
      - name: Check disk space before cleanup
        id: before
        run: |
          echo "=== Disk Space BEFORE Cleanup ==="
          df -h
          echo ""
          echo "=== Root Filesystem Details ==="
          df -h / | tail -n 1 | awk '{print "Root: " $4 " available out of " $2 " total (" $5 " used)"}'
          echo ""
          echo "=== Temp Disk (/mnt) Details ==="
          if mountpoint -q /mnt; then
            df -h /mnt | tail -n 1 | awk '{print "Temp disk: " $4 " available out of " $2 " total (" $5 " used)"}'
          else
            echo "Temp disk not mounted"
          fi
          
          # Capture available space in GB for comparison
          AVAILABLE_BEFORE_ROOT=$(df -BG / | tail -n 1 | awk '{print $4}' | sed 's/G//')
          AVAILABLE_BEFORE_TEMP=$(df -BG /mnt 2>/dev/null | tail -n 1 | awk '{print $4}' | sed 's/G//' || echo "0")
          echo "available_before_root=$AVAILABLE_BEFORE_ROOT" >> $GITHUB_OUTPUT
          echo "available_before_temp=$AVAILABLE_BEFORE_TEMP" >> $GITHUB_OUTPUT
          echo "Available space before - Root: ${AVAILABLE_BEFORE_ROOT}GB, Temp: ${AVAILABLE_BEFORE_TEMP}GB"
          
      - name: Maximize build space (LVM method)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: ${{ inputs.root_reserve_mb }}
          temp-reserve-mb: ${{ inputs.temp_reserve_mb }}
          swap-size-mb: ${{ inputs.swap_size_mb }}
          overprovision-lvm: ${{ inputs.overprovision_lvm }}
          build-mount-path: ${{ inputs.build_mount_path != '' && inputs.build_mount_path || '' }}
          remove-dotnet: ${{ inputs.remove_dotnet && 'true' || 'false' }}
          remove-android: ${{ inputs.remove_android && 'true' || 'false' }}
          remove-haskell: ${{ inputs.remove_haskell && 'true' || 'false' }}
          remove-codeql: ${{ inputs.remove_codeql && 'true' || 'false' }}
          remove-docker-images: ${{ inputs.remove_docker_images && 'true' || 'false' }}
      
      - name: Check disk space after cleanup
        id: after
        run: |
          echo "=== Disk Space AFTER Cleanup ==="
          df -h
          echo ""
          echo "=== Root Filesystem Details ==="
          df -h / | tail -n 1 | awk '{print "Root: " $4 " available out of " $2 " total (" $5 " used)"}'
          echo ""
          echo "=== Temp Disk (/mnt) Details ==="
          if mountpoint -q /mnt; then
            df -h /mnt | tail -n 1 | awk '{print "Temp disk: " $4 " available out of " $2 " total (" $5 " used)"}'
          else
            echo "Temp disk not mounted"
          fi
          echo ""
          echo "=== Build Mount Point (${{ inputs.build_mount_path != '' && inputs.build_mount_path || github.workspace }}) ==="
          BUILD_PATH="${{ inputs.build_mount_path != '' && inputs.build_mount_path || github.workspace }}"
          if [ -d "$BUILD_PATH" ]; then
            df -h "$BUILD_PATH" | tail -n 1 | awk '{print "Build space: " $4 " available out of " $2 " total (" $5 " used)"}'
          fi
          
          # Capture available space in GB for comparison
          AVAILABLE_AFTER_ROOT=$(df -BG / | tail -n 1 | awk '{print $4}' | sed 's/G//')
          AVAILABLE_AFTER_TEMP=$(df -BG /mnt 2>/dev/null | tail -n 1 | awk '{print $4}' | sed 's/G//' || echo "0")
          BUILD_PATH="${{ inputs.build_mount_path != '' && inputs.build_mount_path || github.workspace }}"
          AVAILABLE_AFTER_BUILD=$(df -BG "$BUILD_PATH" 2>/dev/null | tail -n 1 | awk '{print $4}' | sed 's/G//' || echo "0")
          
          echo "available_after_root=$AVAILABLE_AFTER_ROOT" >> $GITHUB_OUTPUT
          echo "available_after_temp=$AVAILABLE_AFTER_TEMP" >> $GITHUB_OUTPUT
          echo "available_after_build=$AVAILABLE_AFTER_BUILD" >> $GITHUB_OUTPUT
          echo "Available space after - Root: ${AVAILABLE_AFTER_ROOT}GB, Temp: ${AVAILABLE_AFTER_TEMP}GB, Build: ${AVAILABLE_AFTER_BUILD}GB"
      
      - name: Check LVM status
        run: |
          echo "=== LVM Volume Groups ==="
          sudo vgs 2>/dev/null || echo "No LVM volume groups found or vgs not available"
          echo ""
          echo "=== LVM Logical Volumes ==="
          sudo lvs 2>/dev/null || echo "No LVM logical volumes found or lvs not available"
          echo ""
          echo "=== Physical Volumes ==="
          sudo pvs 2>/dev/null || echo "No LVM physical volumes found or pvs not available"
          echo ""
          echo "=== Mount Points ==="
          mount | grep -E "(LVM|lvm|vg)" || echo "No LVM mounts found"
      
      - name: Calculate space freed
        run: |
          BEFORE_ROOT=${{ steps.before.outputs.available_before_root }}
          AFTER_ROOT=${{ steps.after.outputs.available_after_root }}
          AFTER_BUILD=${{ steps.after.outputs.available_after_build }}
          
          if [ -n "$BEFORE_ROOT" ] && [ -n "$AFTER_ROOT" ]; then
            FREED_ROOT=$((AFTER_ROOT - BEFORE_ROOT))
            echo "=== Summary ==="
            echo "Root filesystem:"
            echo "  Available space before: ${BEFORE_ROOT}GB"
            echo "  Available space after: ${AFTER_ROOT}GB"
            echo "  Space freed: ${FREED_ROOT}GB"
            echo ""
            
            if [ -n "$AFTER_BUILD" ] && [ "$AFTER_BUILD" != "0" ]; then
              echo "Build mount point:"
              echo "  Available space: ${AFTER_BUILD}GB"
              echo ""
            fi
            
            # Add to summary
            echo "## Disk Space Cleanup Results (LVM Method)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Root filesystem before | ${BEFORE_ROOT}GB |" >> $GITHUB_STEP_SUMMARY
            echo "| Root filesystem after | ${AFTER_ROOT}GB |" >> $GITHUB_STEP_SUMMARY
            echo "| **Space freed on root** | **${FREED_ROOT}GB** |" >> $GITHUB_STEP_SUMMARY
            if [ -n "$AFTER_BUILD" ] && [ "$AFTER_BUILD" != "0" ]; then
              echo "| Build mount available | ${AFTER_BUILD}GB |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### LVM Configuration" >> $GITHUB_STEP_SUMMARY
            echo "- Root reserve: ${{ inputs.root_reserve_mb }}MB" >> $GITHUB_STEP_SUMMARY
            echo "- Temp reserve: ${{ inputs.temp_reserve_mb }}MB" >> $GITHUB_STEP_SUMMARY
            echo "- Swap size: ${{ inputs.swap_size_mb }}MB" >> $GITHUB_STEP_SUMMARY
            echo "- Overprovision LVM: ${{ inputs.overprovision_lvm }}" >> $GITHUB_STEP_SUMMARY
            echo "- Build mount path: ${{ inputs.build_mount_path != '' && inputs.build_mount_path || 'Default ($GITHUB_WORKSPACE)' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Cleanup Options Used" >> $GITHUB_STEP_SUMMARY
            echo "- Remove .NET: ${{ inputs.remove_dotnet }}" >> $GITHUB_STEP_SUMMARY
            echo "- Remove Android: ${{ inputs.remove_android }}" >> $GITHUB_STEP_SUMMARY
            echo "- Remove Haskell: ${{ inputs.remove_haskell }}" >> $GITHUB_STEP_SUMMARY
            echo "- Remove CodeQL: ${{ inputs.remove_codeql }}" >> $GITHUB_STEP_SUMMARY
            echo "- Remove Docker images: ${{ inputs.remove_docker_images }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Note" >> $GITHUB_STEP_SUMMARY
            echo "This action uses LVM to combine space from root and temp disk. The build mount point shows the combined available space." >> $GITHUB_STEP_SUMMARY
          else
            echo "Could not calculate space difference (values may be empty)"
          fi
      
      - name: Show top disk usage directories
        run: |
          echo "=== Top 10 Largest Directories on Root ==="
          sudo du -h --max-depth=1 / 2>/dev/null | sort -hr | head -n 10 || echo "Note: Some directories may not be accessible"
          echo ""
          echo "=== LVM Image Files ==="
          ls -lh /pv.img /mnt/tmp-pv.img 2>/dev/null || echo "LVM image files not found or not accessible"
          echo ""
          echo "=== Swap Information ==="
          free -h
          swapon --show || echo "No swap information available"

