name: Build Stage - Docker Linux (Reusable)

on:
  workflow_call:
    inputs:
      platform:
        description: 'Target platform (must be linux for Docker)'
        required: true
        type: string
      arch:
        description: 'Target architecture (x64, arm64)'
        required: true
        type: string
      stage:
        description: 'Build stage number (1-6)'
        required: true
        type: number
      from_artifact:
        description: 'Resume from previous stage artifact'
        required: true
        type: boolean
      finished:
        description: 'Build already finished in previous stage'
        required: true
        type: string
      build_type:
        description: 'Build type: Component or Release'
        required: false
        type: string
        default: 'Component'
    secrets:
      BRAVE_ENV_CONFIG:
        description: 'Contents of .env file for Brave build'
        required: false
    outputs:
      finished:
        description: 'Whether the build has finished'
        value: ${{ jobs.build.outputs.finished }}

jobs:
  build:
    runs-on: windows-latest
    
    outputs:
      finished: ${{ steps.stage-container.outputs.finished }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Show disk space on Windows D drive
        shell: powershell
        run: |
          Write-Host "=== Windows Disk Space ===" -ForegroundColor Cyan
          $drive = Get-PSDrive D
          $freeGB = [math]::Round($drive.Free/1GB,2)
          Write-Host "D drive - Free: $freeGB GB"
          Write-Host ""
          Write-Host "No cleanup needed - Windows D drive has plenty of space!" -ForegroundColor Green
      
      - name: Setup WSL Ubuntu
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-22.04
          set-as-default: 'true'
      
      - name: Create work directory on D drive
        shell: wsl-bash -u root {0}
        run: |
          mkdir -p /mnt/d/brave-build
          chmod 777 /mnt/d/brave-build
          ls -ld /mnt/d/brave-build
          echo "Work directory ready"
      
      - name: Install build dependencies in WSL
        shell: wsl-bash -u root {0}
        run: |
          set -e
          apt-get update -qq
          DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            build-essential git python3 python3-pip \
            python-setuptools python3-distutils python-is-python3 \
            curl lsb-release sudo tzdata wget ncdu zstd ca-certificates
          curl -fsSL https://deb.nodesource.com/setup_24.x | bash -
          apt-get install -y -qq nodejs
          node --version && npm --version
      
      - name: Install action dependencies
        shell: wsl-bash {0}
        run: |
          cd .github/actions/stage
          npm install --silent
      
      - name: Run build stage ${{ inputs.stage }} in WSL
        id: stage-container
        shell: wsl-bash {0}
        run: |
          set +u
          
          # Convert Windows path to WSL path
          export GITHUB_WORKSPACE=$(wslpath '${{ github.workspace }}')
          
          # Action inputs
          export INPUT_FINISHED="${{ inputs.finished }}"
          export INPUT_FROM_ARTIFACT="${{ inputs.from_artifact }}"
          export INPUT_PLATFORM="${{ inputs.platform }}"
          export INPUT_ARCH="${{ inputs.arch }}"
          export INPUT_BUILD_TYPE="${{ inputs.build_type }}"
          export INPUT_ENV_CONFIG="${{ secrets.BRAVE_ENV_CONFIG }}"
          
          # GitHub context
          export GITHUB_OUTPUT="${GITHUB_OUTPUT:-/tmp/github_output}"
          export ACTIONS_RUNTIME_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export ACTIONS_RUNTIME_URL="${{ env.ACTIONS_RUNTIME_URL }}"
          export ACTIONS_CACHE_URL="${{ env.ACTIONS_CACHE_URL }}"
          export ACTIONS_RESULTS_URL="${{ env.ACTIONS_RESULTS_URL }}"
          export GITHUB_RUN_ID="${{ github.run_id }}"
          export GITHUB_RUN_NUMBER="${{ github.run_number }}"
          export GITHUB_RUN_ATTEMPT="${{ github.run_attempt }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_SHA="${{ github.sha }}"
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          export RUNNER_TEMP="/tmp"
          export HOME="${HOME:-/root}"
          
          set -u
          
          cd .github/actions/stage
          node src/main.js
      
      - name: Show disk usage
        if: always()
        shell: wsl-bash {0}
        run: df -h /mnt/d

