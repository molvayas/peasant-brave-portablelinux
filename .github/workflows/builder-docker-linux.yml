name: Build Stage - Docker Linux (Reusable)

on:
  workflow_call:
    inputs:
      platform:
        description: 'Target platform (must be linux for Docker)'
        required: true
        type: string
      arch:
        description: 'Target architecture (x64, arm64)'
        required: true
        type: string
      stage:
        description: 'Build stage number (1-6)'
        required: true
        type: number
      from_artifact:
        description: 'Resume from previous stage artifact'
        required: true
        type: boolean
      finished:
        description: 'Build already finished in previous stage'
        required: true
        type: string
      build_type:
        description: 'Build type: Component or Release'
        required: false
        type: string
        default: 'Component'
    secrets:
      BRAVE_ENV_CONFIG:
        description: 'Contents of .env file for Brave build'
        required: false
    outputs:
      finished:
        description: 'Whether the build has finished'
        value: ${{ jobs.build.outputs.finished }}

jobs:
  build:
    runs-on: windows-latest
    
    outputs:
      finished: ${{ steps.stage-container.outputs.finished }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Show disk space on Windows D drive
        shell: powershell
        run: |
          Write-Host "=== Windows Disk Space ===" -ForegroundColor Cyan
          $drive = Get-PSDrive D
          $freeGB = [math]::Round($drive.Free/1GB,2)
          Write-Host "D drive - Free: $freeGB GB"
          Write-Host ""
          Write-Host "No cleanup needed - Windows D drive has plenty of space!" -ForegroundColor Green
      
      - name: Setup WSL Ubuntu
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-22.04
          set-as-default: 'true'
          update: 'true'
      
      - name: Test artifact upload from WSL (quick validation)
        shell: powershell
        env:
          ACTIONS_RUNTIME_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTIONS_RUNTIME_URL: ${{ env.ACTIONS_RUNTIME_URL }}
          ACTIONS_CACHE_URL: ${{ env.ACTIONS_CACHE_URL }}
          ACTIONS_RESULTS_URL: ${{ env.ACTIONS_RESULTS_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Set WSLENV to pass environment variables to WSL
          $env:WSLENV = "ACTIONS_RUNTIME_TOKEN/u:ACTIONS_RUNTIME_URL/u:ACTIONS_CACHE_URL/u:ACTIONS_RESULTS_URL/u:GITHUB_RUN_ID/u:GITHUB_RUN_NUMBER/u:GITHUB_RUN_ATTEMPT/u:GITHUB_REPOSITORY/u"
          
          # Create temp script with Unix line endings
          $script = @"
          set -e
          echo '=== Quick artifact upload validation ==='
          echo 'ACTIONS_RUNTIME_TOKEN: `${ACTIONS_RUNTIME_TOKEN:+SET}'
          echo 'ACTIONS_RUNTIME_URL: `${ACTIONS_RUNTIME_URL:+SET}'
          echo 'ACTIONS_CACHE_URL: `${ACTIONS_CACHE_URL:+SET}'
          apt-get update -qq
          DEBIAN_FRONTEND=noninteractive apt-get install -y -qq curl
          curl -fsSL https://deb.nodesource.com/setup_24.x | bash -
          apt-get install -y -qq nodejs
          mkdir -p /tmp/artifact-test
          cd /tmp/artifact-test
          npm init -y > /dev/null 2>&1
          npm install @actions/artifact@2.2.1 > /dev/null 2>&1
          echo 'WSL artifact upload test' > test.txt
          cat > test-upload.js << 'JSEOF'
          const {DefaultArtifactClient} = require('@actions/artifact');
          const artifact = new DefaultArtifactClient();
          (async () => {
            try {
              console.log('Testing artifact upload...');
              const result = await artifact.uploadArtifact('wsl-quick-test', ['/tmp/artifact-test/test.txt'], '/tmp/artifact-test', { retentionDays: 1 });
              console.log('✓ Artifact upload works!');
            } catch (e) {
              console.error('✗ Artifact upload failed:', e.message);
              process.exit(1);
            }
          })();
          JSEOF
          node test-upload.js
          echo '✓ Validation passed - proceeding with build setup'
          "@
          
          # Write with Unix line endings
          $tempScript = "$env:TEMP\wsl-test.sh"
          [System.IO.File]::WriteAllText($tempScript, $script.Replace("`r`n", "`n"))
          
          # Convert Windows path to WSL path and execute
          $wslPath = wsl wslpath -u $tempScript
          wsl bash $wslPath
      
      - name: Create runner user and ext4 filesystem on D drive
        shell: wsl-bash -u root {0}
        run: |
          set -e
          
          echo "Creating runner user..."
          useradd -m -s /bin/bash runner || echo "User already exists"
          
          echo "Configuring passwordless sudo for runner user..."
          echo "runner ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/runner
          chmod 440 /etc/sudoers.d/runner
          
          echo "Creating 140GB virtual disk on D drive (sparse file)..."
          mkdir -p /mnt/d/wsl-vhd
          truncate -s 140G /mnt/d/wsl-vhd/brave-build.ext4
          
          echo "Formatting as ext4..."
          mkfs.ext4 -F /mnt/d/wsl-vhd/brave-build.ext4
          
          echo "Creating mount point and mounting..."
          mkdir -p /home/runner/brave-build
          mount -o loop /mnt/d/wsl-vhd/brave-build.ext4 /home/runner/brave-build
          
          echo "Setting ownership..."
          chown -R runner:runner /home/runner/brave-build
          
          echo "Native ext4 filesystem ready:"
          df -h /home/runner/brave-build
      
      - name: Copy workspace to native filesystem
        shell: wsl-bash {0}
        run: |
          set -e
          
          WINDOWS_WORKSPACE=$(wslpath '${{ github.workspace }}')
          echo "Copying workspace from $WINDOWS_WORKSPACE to /home/runner/brave-build/workspace"
          
          # Copy entire workspace to native filesystem
          mkdir -p /home/runner/brave-build/workspace
          cp -r "$WINDOWS_WORKSPACE/." /home/runner/brave-build/workspace/
          
          echo "Fixing line endings on shell scripts..."
          find /home/runner/brave-build/workspace -type f \( -name "*.sh" -o -name "*.bash" \) -exec sed -i 's/\r$//' {} +
          
          echo "Workspace copied successfully"
          ls -la /home/runner/brave-build/workspace
      
      - name: Install build dependencies in WSL
        shell: wsl-bash -u root {0}
        run: |
          set -e
          echo "Updating package lists..."
          apt-get update -qq
          
          echo "Installing build dependencies..."
          DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            build-essential git python3 python3-pip \
            python-setuptools python3-distutils python-is-python3 \
            curl lsb-release sudo tzdata wget ncdu zstd ca-certificates
          
          echo "Installing Node.js 24.x..."
          curl -fsSL https://deb.nodesource.com/setup_24.x | bash -
          apt-get install -y -qq nodejs
          
          echo "Installed versions:"
          node --version
          npm --version
          python3 --version
      
      - name: Install action dependencies
        shell: wsl-bash {0}
        run: |
          set -e
          
          # Work from native filesystem as runner user
          echo "Installing npm dependencies in native filesystem..."
          sudo -u runner bash -c 'cd /home/runner/brave-build/workspace/.github/actions/stage && npm install'
          echo "Dependencies installed successfully"
      
      - name: Run build stage ${{ inputs.stage }} in WSL
        id: stage-container
        shell: powershell
        env:
          ACTIONS_RUNTIME_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTIONS_RUNTIME_URL: ${{ env.ACTIONS_RUNTIME_URL }}
          ACTIONS_CACHE_URL: ${{ env.ACTIONS_CACHE_URL }}
          ACTIONS_RESULTS_URL: ${{ env.ACTIONS_RESULTS_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          INPUT_FINISHED: ${{ inputs.finished }}
          INPUT_FROM_ARTIFACT: ${{ inputs.from_artifact }}
          INPUT_PLATFORM: ${{ inputs.platform }}
          INPUT_ARCH: ${{ inputs.arch }}
          INPUT_BUILD_TYPE: ${{ inputs.build_type }}
          INPUT_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
        run: |
          # Set WSLENV to pass all necessary environment variables to WSL
          $env:WSLENV = "ACTIONS_RUNTIME_TOKEN/u:ACTIONS_RUNTIME_URL/u:ACTIONS_CACHE_URL/u:ACTIONS_RESULTS_URL/u:GITHUB_RUN_ID/u:GITHUB_RUN_NUMBER/u:GITHUB_RUN_ATTEMPT/u:GITHUB_REPOSITORY/u:GITHUB_SHA/u:GITHUB_REF/u:GITHUB_ACTOR/u:INPUT_FINISHED/u:INPUT_FROM_ARTIFACT/u:INPUT_PLATFORM/u:INPUT_ARCH/u:INPUT_BUILD_TYPE/u:INPUT_ENV_CONFIG/u"
          
          # Create build script with Unix line endings
          $buildScript = @"
          set -e
          echo 'Preparing environment for runner user...'
          echo 'ACTIONS_RUNTIME_TOKEN: `${ACTIONS_RUNTIME_TOKEN:+SET}'
          echo 'ACTIONS_RUNTIME_URL: `${ACTIONS_RUNTIME_URL:+SET}'
          sudo -E -u runner bash << 'RUNNERSCRIPT'
          set -e
          export GITHUB_WORKSPACE='/home/runner/brave-build/workspace'
          export GITHUB_OUTPUT='`${GITHUB_OUTPUT:-/tmp/github_output}'
          export RUNNER_TEMP='`${RUNNER_TEMP:-/tmp}'
          export HOME='/home/runner'
          export GCLIENT_SUPPRESS_GIT_VERSION_WARNING=1
          echo 'Running as user: `$(whoami)'
          echo 'Using native workspace: `$GITHUB_WORKSPACE'
          echo 'ACTIONS_RUNTIME_TOKEN available: `${ACTIONS_RUNTIME_TOKEN:+YES}'
          echo 'Starting build stage...'
          cd "`$GITHUB_WORKSPACE/.github/actions/stage" || exit 1
          node src/main.js
          RUNNERSCRIPT
          "@
          
          # Write with Unix line endings
          $tempBuildScript = "$env:TEMP\wsl-build.sh"
          [System.IO.File]::WriteAllText($tempBuildScript, $buildScript.Replace("`r`n", "`n"))
          
          # Convert Windows path to WSL path and execute
          $wslBuildPath = wsl wslpath -u $tempBuildScript
          wsl bash $wslBuildPath
      
      - name: Show disk usage
        if: always()
        shell: wsl-bash {0}
        run: |
          echo "=== Build directory usage ==="
          df -h /home/runner/brave-build || echo "Build directory not mounted"
          echo ""
          echo "=== Virtual disk file ==="
          ls -lh /mnt/d/wsl-vhd/brave-build.ext4 || echo "Virtual disk not found"
      
      - name: Cleanup virtual filesystem
        if: always()
        shell: wsl-bash -u root {0}
        run: |
          # Unmount if mounted
          umount /home/runner/brave-build 2>/dev/null || echo "Not mounted"
          
          # Keep the virtual disk file - artifacts might still need it
          echo "Virtual disk preserved at D:\\wsl-vhd\\brave-build.ext4"

