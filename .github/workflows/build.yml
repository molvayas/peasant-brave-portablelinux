name: Build Brave Browser (Multi-Platform)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ============================================================================
  # Linux Build Chain (6 stages)
  # ============================================================================
  
  linux-build-1:
    name: Linux x64 - Stage 1
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'

  linux-build-2:
    name: Linux x64 - Stage 2
    needs: linux-build-1
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.linux-build-1.outputs.finished }}

  linux-build-3:
    name: Linux x64 - Stage 3
    needs: linux-build-2
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.linux-build-2.outputs.finished }}

  linux-build-4:
    name: Linux x64 - Stage 4
    needs: linux-build-3
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.linux-build-3.outputs.finished }}

  linux-build-5:
    name: Linux x64 - Stage 5
    needs: linux-build-4
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.linux-build-4.outputs.finished }}

  linux-build-6:
    name: Linux x64 - Stage 6
    needs: linux-build-5
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.linux-build-5.outputs.finished }}

  # ============================================================================
  # macOS Build Chain (6 stages) - Runs in parallel with Linux
  # ============================================================================
  
  macos-build-1:
    name: macOS x64 - Stage 1
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'

  macos-build-2:
    name: macOS x64 - Stage 2
    needs: macos-build-1
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.macos-build-1.outputs.finished }}

  macos-build-3:
    name: macOS x64 - Stage 3
    needs: macos-build-2
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.macos-build-2.outputs.finished }}

  macos-build-4:
    name: macOS x64 - Stage 4
    needs: macos-build-3
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.macos-build-3.outputs.finished }}

  macos-build-5:
    name: macOS x64 - Stage 5
    needs: macos-build-4
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.macos-build-4.outputs.finished }}

  macos-build-6:
    name: macOS x64 - Stage 6
    needs: macos-build-5
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.macos-build-5.outputs.finished }}

  # ============================================================================
  # Publish Releases
  # ============================================================================
  
  publish-linux:
    name: Publish Linux Release
    needs: linux-build-6
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-linux
      
      - name: Publish Linux release to GitHub
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: brave-*.tar.xz

  publish-macos:
    name: Publish macOS Release
    needs: macos-build-6
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-macos
      
      - name: Publish macOS release to GitHub
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: brave-*.tar.xz
