#!/bin/bash
# Apply all Raven patches to the Brave repository

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RAVEN_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
BRAVE_DIR="$RAVEN_DIR/../brave"
PATCHES_DIR="$RAVEN_DIR/patches"
SERIES_FILE="$RAVEN_DIR/series"

# Check if brave directory exists
if [ ! -d "$BRAVE_DIR" ]; then
    echo "Error: Brave directory not found at $BRAVE_DIR"
    exit 1
fi

# Check if series file exists
if [ ! -f "$SERIES_FILE" ]; then
    echo "Error: series file not found at $SERIES_FILE"
    exit 1
fi

echo "Applying Raven patches to Brave..."
echo "Brave directory: $BRAVE_DIR"
echo "Patches directory: $PATCHES_DIR"
echo ""

# Set up git to ignore .pc/ directory (quilt's internal state)
if [ ! -f "$BRAVE_DIR/.git/info/exclude" ]; then
    mkdir -p "$BRAVE_DIR/.git/info"
    touch "$BRAVE_DIR/.git/info/exclude"
fi

if ! grep -q "^\.pc/$" "$BRAVE_DIR/.git/info/exclude" 2>/dev/null; then
    echo ".pc/" >> "$BRAVE_DIR/.git/info/exclude"
    echo "✓ Added .pc/ to git exclude"
fi

# Set up environment for quilt
export QUILT_PATCHES="$PATCHES_DIR"
export QUILT_SERIES="$SERIES_FILE"
export QUILT_PC="$BRAVE_DIR/.pc"

cd "$BRAVE_DIR"

# Check if patches are already applied
if [ -f "$BRAVE_DIR/.pc/applied-patches" ] && [ -s "$BRAVE_DIR/.pc/applied-patches" ]; then
    echo "Patches appear to be already applied. Run ./unapply-patches first."
    exit 1
fi

# Apply all patches
quilt push -a

echo ""
echo "✓ All patches applied successfully!"
echo ""
echo "You can now build Brave with: cd $BRAVE_DIR && npm run build"

